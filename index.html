<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Valcredit — PDF → Excel/CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ✅ Local (sin CDN) -->
  <script src="./pdf.min.js"></script>
  <script src="./xlsx.full.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#f3f4f6;padding:30px}
    .card{background:#fff;max-width:900px;margin:auto;padding:24px;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button{padding:10px 14px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    pre{background:#111827;color:#e5e7eb;padding:14px;border-radius:12px;max-height:280px;overflow:auto;white-space:pre-wrap}
    .muted{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Valcredit — PDF → Excel/CSV</h2>
    <p class="muted">Sube un PDF digital del plan de pagos. Descarga Excel/CSV con desglose Capital vs Aval.</p>

    <div class="row">
      <input id="pdfFile" type="file" accept="application/pdf">
      <button id="btnProcesar">Procesar PDF</button>
      <button id="btnExcel" disabled>Descargar Excel</button>
      <button id="btnCsv" disabled>Descargar CSV</button>
    </div>

    <pre id="log">(esperando PDF)</pre>
  </div>

<script>
const logEl = document.getElementById("log");
const fileEl = document.getElementById("pdfFile");
const btnProcesar = document.getElementById("btnProcesar");
const btnExcel = document.getElementById("btnExcel");
const btnCsv = document.getElementById("btnCsv");

let latestRows = [];
let latestCsv = "";

function log(msg){ logEl.textContent = msg; }

const pdfjsLib = window.pdfjsLib;
if(!pdfjsLib){ log("❌ No cargó PDF.js. Revisa pdf.min.js en la raíz."); throw new Error("pdfjsLib not found"); }
if(!window.XLSX){ log("❌ No cargó SheetJS. Revisa xlsx.full.min.js."); throw new Error("XLSX not found"); }

pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdf.worker.min.js";

function normalizeText(t){
  return (t||"").replace(/\u00A0/g," ").replace(/[ \t]+/g," ").replace(/\n+/g,"\n");
}
function parseMoneyToInt(v){
  const d = String(v||"").replace(/[^\d]/g,"");
  return d ? parseInt(d,10) : 0;
}
function escapeCsv(v){
  const s = (v===null||v===undefined) ? "" : String(v);
  return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}
function downloadBlob(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

async function extractTextFromPdf(file){
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buffer}).promise;
  let text = "";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(it=>it.str).join(" ") + "\n";
  }
  return text;
}

function extractValorAval(text){
  const m = text.match(/Valor\s+aval\s*\$?\s*([\d\.,]+)/i);
  return m ? parseMoneyToInt(m[1]) : 0;
}
function extractNumeroCuotas(text){
  const m = text.match(/Número\s+de\s+cuotas:\s*(\d+)/i);
  return m ? parseInt(m[1],10) : 0;
}
function extractRows(text){
  const rows = [];

  // Cuota inicial
  const init = text.match(/Cuota\s+inicial\s*\$?\s*([\d\.,]+)\s+(Pago\s+inmediato)/i);
  if(init){
    rows.push({cuota:"Cuota inicial", valor_cuota:parseMoneyToInt(init[1]), fecha_pago:init[2]});
  }

  // Cuotas numeradas
  const re = /(\d+)\s*\$?\s*([\d\.,]+)\s+(\d{2}-\d{2}-\d{4})/g;
  let m;
  while((m=re.exec(text))!==null){
    rows.push({cuota:parseInt(m[1],10), valor_cuota:parseMoneyToInt(m[2]), fecha_pago:m[3]});
  }

  rows.sort((a,b)=>{
    if(a.cuota==="Cuota inicial") return -1;
    if(b.cuota==="Cuota inicial") return 1;
    return a.cuota - b.cuota;
  });
  return rows;
}
function inferNumeroCuotas(rows){
  const nums = rows.filter(r=>typeof r.cuota==="number").map(r=>r.cuota);
  return nums.length ? Math.max(...nums) : 0;
}
function buildAvalParts(valorAval, n){
  if(!valorAval || !n) return Array(n).fill(0);
  const base = Math.floor(valorAval/n);
  let rem = valorAval - base*n;
  const parts = Array(n).fill(base);
  for(let i=0;i<n && rem>0;i++,rem--) parts[i] += 1; // reparte residuo exacto
  return parts;
}
function applyAval(rows, valorAval, nCuotas){
  const n = nCuotas || inferNumeroCuotas(rows);
  const parts = buildAvalParts(valorAval, n);

  return rows.map(r=>{
    const isCuota = (typeof r.cuota==="number" && r.cuota>=1);
    const aval = isCuota ? parts[r.cuota-1] : 0;
    const total = r.valor_cuota || 0;
    return {
      cuota: r.cuota,
      valor_cuota: total,
      fecha_pago: r.fecha_pago || "",
      valor_aval_total: valorAval,
      aval_prorrateado: aval,
      valor_capital: total - aval
    };
  });
}
function rowsToCsv(rows){
  const headers=["cuota","valor_cuota","fecha_pago","valor_aval_total","aval_prorrateado","valor_capital"];
  const lines=[headers.join(",")];
  for(const r of rows) lines.push(headers.map(h=>escapeCsv(r[h])).join(","));
  return lines.join("\n");
}
function rowsToXlsxBlob(rows){
  const ws = XLSX.utils.json_to_sheet(rows, {header:["cuota","valor_cuota","fecha_pago","valor_aval_total","aval_prorrateado","valor_capital"]});
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "PlanPagos");
  const buf = XLSX.write(wb, {bookType:"xlsx", type:"array"});
  return new Blob([buf], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
}

btnProcesar.addEventListener("click", async ()=>{
  const file = fileEl.files?.[0];
  if(!file){ alert("Sube un PDF"); return; }

  try{
    btnExcel.disabled=true; btnCsv.disabled=true;
    latestRows=[]; latestCsv="";
    log("⏳ Leyendo PDF…");

    const raw = await extractTextFromPdf(file);
    const text = normalizeText(raw);

    const valorAval = extractValorAval(text);
    let nCuotas = extractNumeroCuotas(text);

    const baseRows = extractRows(text);
    if(!baseRows.length) throw new Error("No detecté cuotas (¿PDF escaneado o formato distinto?).");

    if(!nCuotas) nCuotas = inferNumeroCuotas(baseRows);

    latestRows = applyAval(baseRows, valorAval, nCuotas);
    latestCsv = rowsToCsv(latestRows);

    log("✅ OK\n\nResumen:\n- Cuotas detectadas: "+nCuotas+"\n- Valor aval: "+valorAval+"\n- Filas: "+latestRows.length+"\n\nVista previa CSV:\n\n"+latestCsv);

    btnExcel.disabled=false; btnCsv.disabled=false;
  }catch(e){
    console.error(e);
    log("❌ Error: " + (e.message || e));
  }
});

btnExcel.addEventListener("click", ()=>{
  if(!latestRows.length) return;
  downloadBlob("plan_de_pagos.xlsx", rowsToXlsxBlob(latestRows));
});
btnCsv.addEventListener("click", ()=>{
  if(!latestCsv) return;
  downloadBlob("plan_de_pagos.csv", new Blob([latestCsv], {type:"text/csv;charset=utf-8"}));
});
</script>
</body>
</html>
